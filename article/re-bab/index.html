<!doctype html>
<html ⚡ lang="en">
<head>
  <meta charset="utf-8">
<title>How an anti ad-blocker works: Reverse-engineering BlockAdBlock</title>
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

<link rel="stylesheet" href="http://example.org/custom/style.fa0e8bc0bf80247e5f0b013d84eb40e57562be04d8c8d989b73c2782cb69b7b1.css">

    
    
    <link rel="stylesheet" href="http://example.org/article/re-bab/custom/style.css">

<meta name="description" content="How I reversed an ad-blocker blocker and learned some history about ad-blocking.">
<meta name="keywords"
    content="hugo elhaj-lahsen, hugo elhaj lahsen, xy2_, xy2, computer science, blog, functional programming, lisp, reverse engineering, reversing, data visualisation, data science, datavis, dataviz">
<meta property="og:type" content="website">
<meta property="og:title" content="How an anti ad-blocker works: Reverse-engineering BlockAdBlock">
<meta property="og:url" content="http://example.org/article/re-bab/">
<meta property="og:site_name" content="How an anti ad-blocker works: Reverse-engineering BlockAdBlock">
<meta property="og:description" content="How I reversed an ad-blocker blocker and learned some history about ad-blocking.">
<meta property="og:locale" content="en">

    
        <meta property="og:image" content="http://example.org/article/re-bab/cover.webp">
        <meta name="twitter:image" content="http://example.org/article/re-bab/cover.webp">
    

<meta name="twitter:card" content="summary">
<link rel="canonical" href="http://example.org/article/re-bab/">
<link rel="shortcut icon" href="/favicon.png">
<link href="http://example.org/apple-icon.png" rel="apple-touch-icon" />

</head>  
<body>
  <div class="container">
    <a class="sidebar" href="http://example.org/">
      <img class="sidebar-img" src="/img/leitmotif.png">
      <span class="sidebar-name">xy2_</span>
    </a>
    <nav class="about">
      <div class="presentation-sm">
        
        
          <a class="btn " href="/about/">
            About
          </a> 
        
          <a class="btn " href="/portfolio/">
            Portfolio
          </a> 
        
          <a class="btn " href="/">
            Posts
          </a> 
        
          <a class="btn " href="/contact/">
            Contact
          </a> 
        
      </div>
      <div class="presentation-md">
        
        
        <p class="about-title">about -></p>
        <div>
          <a class="btn " href="/about/">Hi! I&#39;m Hugo.</a> 
        </div>
        
        <p class="about-title">portfolio -></p>
        <div>
          <a class="btn " href="/portfolio/">I make software.</a> 
        </div>
        
        <p class="about-title">posts -></p>
        <div>
          <a class="btn " href="/">I write about it.</a> 
        </div>
        
        <p class="about-title">contact -></p>
        <div>
          <a class="btn " href="/contact/">Let&#39;s talk!</a> 
        </div>
        
      </div>
    </nav>
    <main class="main">
     
<div class="post">
    <h1>How an anti ad-blocker works: Reverse-engineering BlockAdBlock</h1>
    <div class="info">
        <span class="date">
            <i data-feather="calendar"></i>March 26, 2020
        </span>
        <div class="categories">
        
            
            
            <a class="category btn" href="http://example.org/categories/reverse-engineering">
                Reverse Engineering
            </a>
            
        
        </div>
    </div>
    <div class="content">
        <p>If you&rsquo;ve used an adblocker, you may have seen <a href="https://blockadblock.com/">BlockAdBlock</a>.
This script detects your ad-blocker and disables website access until you deactivate your adblocker.
But I found myself wondering how it worked.
How does an anti ad-blocker detect adblockers?
And how do adblockers react and block ad-block-blockers?</p>
<h2 id="reverse-engineering-through-time">Reverse-engineering through time</h2>
<p>The first thing I did was look at <a href="https://blockadblock.com/configure.php">their site</a>.
BlockAdBlock offers a configurator that allows to specify how long to wait, and how the script even appeared, creating different <em>versions</em> of the script.</p>
<p>And this got me thinking about versions. What if I could not look at one version, but <strong>all</strong> of them? So I did. I went back in time, using the <strong><a href="https://archive.org/web/">Wayback Machine</a></strong>.
After I downloaded all versions, I took a look and hashed them:</p>

<details >
    
    <summary>The list of all BlockAdBlock versions, with <code>sha1sum</code>. <em><!-- raw HTML omitted -->Click to unroll!<!-- raw HTML omitted --></em></summary>
    
        <div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-plaintext" data-lang="plaintext"><span style="display:block;width:100%;background-color:#3c3d38">6d5eafab2ca816ccd049ad8f796358c0a7a43cf3  20151007203811.js
</span><span style="display:block;width:100%;background-color:#3c3d38">065b4aa813b219abbce76ad20a3216b3481b11bb  20151113115955.js
</span><span style="display:block;width:100%;background-color:#3c3d38">d5dec97a775b2e563f3e4359e4f8f1c3645ba0e5  20160121132336.js
</span><span style="display:block;width:100%;background-color:#3c3d38">8add06cbb79bc25114bd7a2083067ceea9fbb354  20160318193101.js
</span>8add06cbb79bc25114bd7a2083067ceea9fbb354  20160319042810.js
8add06cbb79bc25114bd7a2083067ceea9fbb354  20160331051645.js
8add06cbb79bc25114bd7a2083067ceea9fbb354  20160406061855.js
8add06cbb79bc25114bd7a2083067ceea9fbb354  20160408025028.js
<span style="display:block;width:100%;background-color:#3c3d38">555637904dc9e4bfc6f08bdcae92f0ba0f443ebf  20160415083215.js
</span><span style="display:block;width:100%;background-color:#3c3d38">d8986247cad3bbc2dd92c3a2a06ac1540da6b286  20161120215354.js
</span>d8986247cad3bbc2dd92c3a2a06ac1540da6b286  20170525201720.js
d8986247cad3bbc2dd92c3a2a06ac1540da6b286  20170606090847.js
d8986247cad3bbc2dd92c3a2a06ac1540da6b286  20170703211338.js
d8986247cad3bbc2dd92c3a2a06ac1540da6b286  20170707211652.js
d8986247cad3bbc2dd92c3a2a06ac1540da6b286  20170813090718.js
d8986247cad3bbc2dd92c3a2a06ac1540da6b286  20170915094808.js
d8986247cad3bbc2dd92c3a2a06ac1540da6b286  20171005180631.js
d8986247cad3bbc2dd92c3a2a06ac1540da6b286  20171019162109.js
d8986247cad3bbc2dd92c3a2a06ac1540da6b286  20171109101135.js
d8986247cad3bbc2dd92c3a2a06ac1540da6b286  20171127113945.js
d8986247cad3bbc2dd92c3a2a06ac1540da6b286  20171211042454.js
d8986247cad3bbc2dd92c3a2a06ac1540da6b286  20171227031408.js
d8986247cad3bbc2dd92c3a2a06ac1540da6b286  20180202000800.js
d8986247cad3bbc2dd92c3a2a06ac1540da6b286  20180412213253.js
d8986247cad3bbc2dd92c3a2a06ac1540da6b286  20180419060636.js
d8986247cad3bbc2dd92c3a2a06ac1540da6b286  20180530223228.js
d8986247cad3bbc2dd92c3a2a06ac1540da6b286  20180815042610.js
d8986247cad3bbc2dd92c3a2a06ac1540da6b286  20181029233809.js
d8986247cad3bbc2dd92c3a2a06ac1540da6b286  20181122190948.js
d8986247cad3bbc2dd92c3a2a06ac1540da6b286  20181122205748.js
d8986247cad3bbc2dd92c3a2a06ac1540da6b286  20190324081812.js
d8986247cad3bbc2dd92c3a2a06ac1540da6b286  20190420155244.js
d8986247cad3bbc2dd92c3a2a06ac1540da6b286  20190424200651.js
d8986247cad3bbc2dd92c3a2a06ac1540da6b286  20190903121933.js
d8986247cad3bbc2dd92c3a2a06ac1540da6b286  20200112084838.js
</code></pre></div>
    </details>

<aside class="aside-details">Only <em>six</em> payloads are different, and there are no updates in <strong>four</strong> years.</aside>

<p>There were six versions, and the last one is from 2016, although I still see sites using BlockAdBlock today.
This is a huge win, because we can reverse the script once, then reverse each <!-- raw HTML omitted -->diff<!-- raw HTML omitted -->. We can see scrapped ideas and even leftover debug code.</p>
<p>You can find <a href="https://github.com/xy2iii/BlockAdBlock-reversed">each version on GitHub</a>.
If you&rsquo;d like to look at each diff, see <a href="https://github.com/xy2iii/bab-history">this repository</a> where each commit is a different version. <!-- raw HTML omitted -->I&rsquo;ll include links to the source for each section of this reversing, don&rsquo;t worry.<!-- raw HTML omitted --></p>
<h2 id="unpacking">Unpacking</h2>
<p>As we look at the code, we find that it is not minified, but instead packed by a <a href="http://dean.edwards.name/packer/">JS packer</a> by Dean Edwards.<sup id="fnref:1"><a href="#fn:1" class="footnote-ref" role="doc-noteref">1</a></sup></p>

<details open>
    
    <summary>Dean Edwards' <a href="http://dean.edwards.name/packer/">packer</a> in BlockAdBlock: only an argument&rsquo;s name changes.</summary>
    
        <div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-js" data-lang="js">eval(<span style="color:#66d9ef">function</span>(<span style="color:#a6e22e">p</span>, <span style="color:#a6e22e">a</span>, <span style="color:#a6e22e">c</span>, <span style="color:#a6e22e">k</span>, <span style="color:#a6e22e">e</span>, <span style="color:#a6e22e">d</span>) {
    <span style="color:#a6e22e">e</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">function</span>(<span style="color:#a6e22e">c</span>) {
        <span style="color:#66d9ef">return</span> (<span style="color:#a6e22e">c</span> <span style="color:#f92672">&lt;</span> <span style="color:#a6e22e">a</span> <span style="color:#f92672">?</span> <span style="color:#e6db74">&#39;&#39;</span> <span style="color:#f92672">:</span> <span style="color:#a6e22e">e</span>(parseInt(<span style="color:#a6e22e">c</span> <span style="color:#f92672">/</span> <span style="color:#a6e22e">a</span>))) <span style="color:#f92672">+</span> ((<span style="color:#a6e22e">c</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">c</span> <span style="color:#f92672">%</span> <span style="color:#a6e22e">a</span>) <span style="color:#f92672">&gt;</span> <span style="color:#ae81ff">35</span> <span style="color:#f92672">?</span> String.<span style="color:#a6e22e">fromCharCode</span>(<span style="color:#a6e22e">c</span> <span style="color:#f92672">+</span> <span style="color:#ae81ff">29</span>) <span style="color:#f92672">:</span> <span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">toString</span>(<span style="color:#ae81ff">36</span>))
    };
    <span style="color:#66d9ef">if</span> (<span style="color:#f92672">!</span><span style="color:#e6db74">&#39;&#39;</span>.<span style="color:#a6e22e">replace</span>(<span style="color:#e6db74">/^/</span>, String)) {
        <span style="color:#66d9ef">while</span> (<span style="color:#a6e22e">c</span><span style="color:#f92672">--</span>) {
            <span style="color:#a6e22e">d</span>[<span style="color:#a6e22e">e</span>(<span style="color:#a6e22e">c</span>)] <span style="color:#f92672">=</span> <span style="color:#a6e22e">k</span>[<span style="color:#a6e22e">c</span>] <span style="color:#f92672">||</span> <span style="color:#a6e22e">e</span>(<span style="color:#a6e22e">c</span>)
        }
        <span style="color:#a6e22e">k</span> <span style="color:#f92672">=</span> [<span style="color:#66d9ef">function</span>(<span style="color:#a6e22e">e</span>) {
            <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">d</span>[<span style="color:#a6e22e">e</span>]
        }];
        <span style="color:#a6e22e">e</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">function</span>() {
            <span style="color:#66d9ef">return</span> <span style="color:#e6db74">&#39;\\w+&#39;</span>
        };
        <span style="color:#a6e22e">c</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>
    };
    <span style="color:#66d9ef">while</span> (<span style="color:#a6e22e">c</span><span style="color:#f92672">--</span>) {
        <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">k</span>[<span style="color:#a6e22e">c</span>]) {
            <span style="color:#a6e22e">p</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">p</span>.<span style="color:#a6e22e">replace</span>(<span style="color:#66d9ef">new</span> RegExp(<span style="color:#e6db74">&#39;\\b&#39;</span> <span style="color:#f92672">+</span> <span style="color:#a6e22e">e</span>(<span style="color:#a6e22e">c</span>) <span style="color:#f92672">+</span> <span style="color:#e6db74">&#39;\\b&#39;</span>, <span style="color:#e6db74">&#39;g&#39;</span>), <span style="color:#a6e22e">k</span>[<span style="color:#a6e22e">c</span>])
        }
    }
    <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">p</span>
}(<span style="color:#e6db74">&#39;0.1(&#34;2 3 4 5 6 7 8\&#39;d. 9, h? a b c d e f g&#34;);i j=\&#39;a\&#39;+\&#39;k\&#39;+\&#39;e\&#39;+\&#39;l\&#39;+\&#39;n\&#39;+\&#39;m\&#39;+\&#39;e\&#39;;&#39;</span>,<span style="color:#ae81ff">24</span>,<span style="color:#ae81ff">24</span>,
<span style="color:#e6db74">&#39;console|log|This|code|will|get|unpacked|then|eval|Cool||||||||huh|let|you|w|s||o&#39;</span>.<span style="color:#a6e22e">split</span>(<span style="color:#e6db74">&#39;|&#39;</span>),<span style="color:#ae81ff">0</span>,{}))
</code></pre></div>
    </details>

<aside class="aside-details">p,a,c,k,e,r becomes p,a,c,k,e,d. There is no other modification to the logic.</aside>

<p>Thankfully, we don&rsquo;t have to worry about this.
The packer&rsquo;s  weakness is that any code it unpacks must be passed to <code>eval()</code>.
If we replace the <code>eval()</code> with something like <code>console.log()</code>, suddently we get the whole source code and the packer is defeated.<sup id="fnref:2"><a href="#fn:2" class="footnote-ref" role="doc-noteref">2</a></sup></p>
<p>Once we&rsquo;ve done that for each version, we can examine each version, as well as the added features over the years.</p>
<!-- raw HTML omitted -->
<h2 id="version-1----november-2015-initial-script">Version 1 (? - November 2015): initial script</h2>
<div class="github-code">
    <i data-feather="github"></i>
    <a href="https://github.com/xy2iii/BlockAdBlock-reversed/blob/master/v1-reversed.js">Source code</a>
</div>
<p>We start by taking a look at <code>20151007203811.js</code>, around November 2015.<sup id="fnref:3"><a href="#fn:3" class="footnote-ref" role="doc-noteref">3</a></sup> Although this first version does very little adblock-blocking, it allows us to take a look at BlockAdBlock&rsquo;s architecture, without the cruft that accumulated over the years.</p>
<h3 id="architecture">Architecture</h3>
<p>In three sentences:</p>
<ul>
<li>BlockAdBlock is a closure returning an object with three functions:
<ul>
<li><code>bab()</code>, which sets up bait most of the time, calling <code>check</code></li>
<li><code>check()</code>, which checks if the adblocker blocked the bait, calling <code>arm</code></li>
<li><code>arm()</code>, which creates the overlay.</li>
</ul>
</li>
<li>The entrypoint, <code>bab()</code>, is then fired after a set amount of time.</li>
<li>The three returned functions are generated with arguments from the closure, which are set in the <a href="https://blockadblock.com/configure.php">BlockAdBlock customizer</a>.</li>
</ul>

<details open>
    
    <summary>The code is built around a closure, assigned to a global object with a random name.</summary>
    
        <div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-js" data-lang="js"><span style="color:#66d9ef">var</span> <span style="color:#a6e22e">randomID</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;&#39;</span>,
    <span style="color:#a6e22e">e</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789&#39;</span>;
<span style="color:#66d9ef">for</span> (<span style="color:#66d9ef">var</span> <span style="color:#a6e22e">i</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>; <span style="color:#a6e22e">i</span> <span style="color:#f92672">&lt;</span> <span style="color:#ae81ff">12</span>; <span style="color:#a6e22e">i</span><span style="color:#f92672">++</span>) <span style="color:#a6e22e">randomID</span> <span style="color:#f92672">+=</span> 
    <span style="color:#a6e22e">e</span>.<span style="color:#a6e22e">charAt</span>(Math.<span style="color:#a6e22e">floor</span>(Math.<span style="color:#a6e22e">random</span>() <span style="color:#f92672">*</span> <span style="color:#a6e22e">e</span>.<span style="color:#a6e22e">length</span>));
<span style="color:#66d9ef">var</span> <span style="color:#a6e22e">setTimeoutDelay</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">7</span>; <span style="color:#75715e">// Delay after which to call BlockAdBlock
</span><span style="color:#75715e"></span>window[<span style="color:#e6db74">&#39;&#39;</span> <span style="color:#f92672">+</span> <span style="color:#a6e22e">randomID</span> <span style="color:#f92672">+</span> <span style="color:#e6db74">&#39;&#39;</span>] <span style="color:#f92672">=</span> ...
</code></pre></div>
    </details>

<aside class="aside-details">There is great care in the code to have most names generated randomly, so as to avoid static blocking.</aside>


<details open>
    
    <summary>It returns a three-function object: <code>bab</code>, <code>check</code> and <code>arm</code>.</summary>
    
        <div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-js" data-lang="js">window[<span style="color:#e6db74">&#39;&#39;</span> <span style="color:#f92672">+</span> <span style="color:#a6e22e">randomID</span> <span style="color:#f92672">+</span> <span style="color:#e6db74">&#39;&#39;</span>] <span style="color:#f92672">=</span> (<span style="color:#66d9ef">function</span>() {
    <span style="color:#66d9ef">var</span> <span style="color:#a6e22e">eid</span> <span style="color:#f92672">=</span> ...
    <span style="color:#66d9ef">return</span> {
        <span style="color:#a6e22e">bab</span><span style="color:#f92672">:</span> <span style="color:#66d9ef">function</span>(<span style="color:#a6e22e">check</span>, <span style="color:#a6e22e">passed_eid</span>) {},
        <span style="color:#a6e22e">check</span><span style="color:#f92672">:</span> <span style="color:#66d9ef">function</span>(<span style="color:#a6e22e">checkPredicate</span>, <span style="color:#a6e22e">unused</span>) {},
        <span style="color:#a6e22e">arm</span><span style="color:#f92672">:</span> <span style="color:#66d9ef">function</span>() {}
    }
})();
</code></pre></div>
    </details>

<aside class="aside-details">bab, check and arm are my own names. All variables were minified, and some were intentionally obfuscated.</aside>


<details open>
    
    <summary>The entrypoint, <code>bab()</code>, is called via <code>setTimeout()</code>.</summary>
    
        <div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-js" data-lang="js"><span style="color:#a6e22e">setTimeout</span>(<span style="color:#e6db74">&#39;window[\&#39;\&#39; + randomID + \&#39;\&#39;] \
</span><span style="color:#e6db74">.bab(window[\&#39;\&#39; + randomID + \&#39;\&#39;].check, \
</span><span style="color:#e6db74">     window[\&#39;\&#39; + randomID + \&#39;\&#39;].bab_elementid)&#39;</span>, <span style="color:#a6e22e">setTimeoutDelay</span> <span style="color:#f92672">*</span> <span style="color:#ae81ff">1000</span>);
</code></pre></div>
    </details>

<aside class="aside-details">bab_elementid is unused in all versions of the code. <code>setTimeout</code> is passed a string.</aside>

<p>The closure has outer variables. Two of them serve to keep state in the script:</p>
<ul>
<li><code>adblockDetected</code> is 1 if an adblocker is detected.</li>
<li><code>nagMode</code> is a customization option. If set, the script will only nag you once to disable your adblocker, rather than block access.</li>
</ul>

<details >
    
    <summary>Other outer variables in the closure control apparence and behavior, set in the <a href="https://blockadblock.com/configure.php">customizer</a>.</summary>
    
        <div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-js" data-lang="js"><span style="color:#66d9ef">var</span> <span style="color:#a6e22e">eid</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39; ad_box&#39;</span>, <span style="color:#75715e">// Name of the bait.
</span><span style="color:#75715e"></span>    <span style="color:#a6e22e">__u1</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>, <span style="color:#75715e">// Unused.
</span><span style="color:#75715e"></span>
    <span style="color:#75715e">// Colors for the blockadblock prompt.
</span><span style="color:#75715e"></span>    <span style="color:#a6e22e">overlayColor</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;#EEEEEE&#39;</span>,
    <span style="color:#a6e22e">textColor</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;#777777&#39;</span>,
    <span style="color:#a6e22e">buttonBackgroundColor</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;#adb8ff&#39;</span>,
    <span style="color:#a6e22e">buttonColor</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;#FFFFFF&#39;</span>,

    <span style="color:#a6e22e">__u2</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;&#39;</span>, <span style="color:#75715e">// Unused.
</span><span style="color:#75715e"></span>
    <span style="color:#75715e">// Text to display when the blockadblock prompt is shown.
</span><span style="color:#75715e"></span>    <span style="color:#a6e22e">welcomeText</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;Sorry for the interruption...&#39;</span>,
    <span style="color:#a6e22e">primaryText</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;It looks like you\&#39;re using an ad blocker. That\&#39;s okay.  Who doesn\&#39;t?&#39;</span>,
    <span style="color:#a6e22e">subtextText</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;But without advertising-income, we can\&#39;t keep making this site awesome.&#39;</span>,
    <span style="color:#a6e22e">buttonText</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;I understand, I have disabled my ad blocker.  Let me in!&#39;</span>,

    <span style="color:#75715e">// If 1, adblock was detected.
</span><span style="color:#75715e"></span>    <span style="color:#a6e22e">adblockDetected</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>,
    <span style="color:#75715e">// If 1, BlockAdBlock will only nag the visitor once, rather than block access.
</span><span style="color:#75715e"></span>    <span style="color:#a6e22e">nagMode</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>,

    <span style="color:#75715e">// The blockadblock domain, reversed.
</span><span style="color:#75715e"></span>    <span style="color:#a6e22e">bab_domain</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;moc.kcolbdakcolb&#39;</span>;
</code></pre></div>
    </details>

<aside class="aside-details">bab_domain is set here to try to obfuscate the BlockAdBlock domain.</aside>

<h3 id="bab-bait-ad-creation"><code>bab</code>: bait ad creation</h3>
<p>BlockAdBlock&rsquo;s central detection method is by creating &ldquo;bait&rdquo; ad elements, that look like real ads.
It then checks if the adblocker blocked them.</p>

<details open>
    
    <summary>A bait is created: a fake div pretending to be an ad, but hidden out of view.</summary>
    
        <div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-js" data-lang="js"><span style="color:#a6e22e">bab</span><span style="color:#f92672">:</span> <span style="color:#66d9ef">function</span>(<span style="color:#a6e22e">check</span>, <span style="color:#a6e22e">passed_eid</span>) {
    <span style="color:#75715e">// Wait for the document to be ready.
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">if</span> (<span style="color:#66d9ef">typeof</span> document.<span style="color:#a6e22e">body</span> <span style="color:#f92672">==</span> <span style="color:#e6db74">&#39;undefined&#39;</span>) {
        <span style="color:#66d9ef">return</span>
    };

    <span style="color:#66d9ef">var</span> <span style="color:#a6e22e">delay</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;0.1&#39;</span>, 
        <span style="color:#a6e22e">passed_eid</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">eid</span> <span style="color:#f92672">?</span> <span style="color:#a6e22e">eid</span> <span style="color:#f92672">:</span> <span style="color:#e6db74">&#39;banner_ad&#39;</span>,
        <span style="color:#a6e22e">bait</span> <span style="color:#f92672">=</span> document.<span style="color:#a6e22e">createElement</span>(<span style="color:#e6db74">&#39;DIV&#39;</span>);
        
    <span style="color:#a6e22e">bait</span>.<span style="color:#a6e22e">id</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">passed_eid</span>;
    <span style="color:#a6e22e">bait</span>.<span style="color:#a6e22e">style</span>.<span style="color:#a6e22e">position</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;absolute&#39;</span>;
    <span style="color:#a6e22e">bait</span>.<span style="color:#a6e22e">style</span>.<span style="color:#a6e22e">left</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;-999px&#39;</span>;
    <span style="color:#a6e22e">bait</span>.<span style="color:#a6e22e">appendChild</span>(document.<span style="color:#a6e22e">createTextNode</span>(<span style="color:#e6db74">&#39; &#39;</span>));
    document.<span style="color:#a6e22e">body</span>.<span style="color:#a6e22e">appendChild</span>(<span style="color:#a6e22e">bait</span>);
    ...
</code></pre></div>
    </details>

<aside class="aside-details">passed_eid is presumably to customise the id of the bait, but it&rsquo;s unused.</aside>


<details open>
    
    <summary>Afterwards, <code>check</code> if the bait was removed by the adblocker.</summary>
    
        <div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-js" data-lang="js">    ...
    <span style="color:#a6e22e">setTimeout</span>(<span style="color:#66d9ef">function</span>() {
        <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">bait</span>) {
            <span style="color:#a6e22e">check</span>((<span style="color:#a6e22e">bait</span>.<span style="color:#a6e22e">clientHeight</span> <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span>), <span style="color:#a6e22e">delay</span>);
            <span style="color:#a6e22e">check</span>((<span style="color:#a6e22e">bait</span>.<span style="color:#a6e22e">clientWidth</span> <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span>), <span style="color:#a6e22e">delay</span>);
            <span style="color:#a6e22e">check</span>((<span style="color:#a6e22e">bait</span>.<span style="color:#a6e22e">display</span> <span style="color:#f92672">==</span> <span style="color:#e6db74">&#39;hidden&#39;</span>), <span style="color:#a6e22e">delay</span>);
            <span style="color:#a6e22e">check</span>((<span style="color:#a6e22e">bait</span>.<span style="color:#a6e22e">visibility</span> <span style="color:#f92672">==</span> <span style="color:#e6db74">&#39;none&#39;</span>), <span style="color:#a6e22e">delay</span>);
            <span style="color:#a6e22e">check</span>((<span style="color:#a6e22e">bait</span>.<span style="color:#a6e22e">opacity</span> <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span>), <span style="color:#a6e22e">delay</span>);
            <span style="color:#a6e22e">check</span>((<span style="color:#a6e22e">bait</span>.<span style="color:#a6e22e">left</span> <span style="color:#f92672">&lt;</span> <span style="color:#ae81ff">1000</span>), <span style="color:#a6e22e">delay</span>);
            <span style="color:#a6e22e">check</span>((<span style="color:#a6e22e">bait</span>.<span style="color:#a6e22e">top</span> <span style="color:#f92672">&lt;</span> <span style="color:#ae81ff">1000</span>), <span style="color:#a6e22e">delay</span>)
        } <span style="color:#66d9ef">else</span> {
            <span style="color:#a6e22e">check</span>(<span style="color:#66d9ef">true</span>, <span style="color:#a6e22e">delay</span>)
        }
    }, <span style="color:#ae81ff">125</span>)
}
</code></pre></div>
    </details>

<aside class="aside-details">If the bait doesn&rsquo;t exist anymore, then the element was removed (and we trigger the overlay).</aside>


<details open>
    
    <summary><code>check</code> will trigger if the predicate was true, and trigger <code>arm</code>.</summary>
    
        <div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-js" data-lang="js"><span style="color:#a6e22e">check</span><span style="color:#f92672">:</span> <span style="color:#66d9ef">function</span>(<span style="color:#a6e22e">checkPredicate</span>, <span style="color:#a6e22e">unused</span>) {
    <span style="color:#66d9ef">if</span> ((<span style="color:#a6e22e">checkPredicate</span>) <span style="color:#f92672">&amp;&amp;</span> (<span style="color:#a6e22e">adblockDetected</span> <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span>)) {
        <span style="color:#a6e22e">adblockDetected</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>;
        window[<span style="color:#e6db74">&#39;&#39;</span> <span style="color:#f92672">+</span> <span style="color:#a6e22e">randomID</span> <span style="color:#f92672">+</span> <span style="color:#e6db74">&#39;&#39;</span>].<span style="color:#a6e22e">arm</span>()
    } <span style="color:#66d9ef">else</span> {}
}
</code></pre></div>
    </details>

<aside class="aside-details">Because <code>check</code> triggers multiple times as seen above, <code>adblockDetected</code> is set on the first correct check, in order to avoid triggering <code>arm</code> multiple times.</aside>

<h3 id="nag-mode">Nag mode</h3>
<p>BlockAdBlock has an feature called &ldquo;nag mode&rdquo;: in this mode, BlockAdBlock will only tell you to remove your adblocker once, instead of blocking you on each visit.
It does so by setting a <code>localStorage</code> item after the first visit.</p>
<p>If we could set this for every, could we bypass BlockAdBlock forever? Unfortunately, BlockAdBlock checks beforehand if the script has been configured to nag mode, so this won&rsquo;t work for default usage, which is to block every time.</p>

<details open>
    
    <summary>The start of <code>arm</code>, checking for nag mode.</summary>
    
        <div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-js" data-lang="js"><span style="color:#a6e22e">arm</span><span style="color:#f92672">:</span> <span style="color:#66d9ef">function</span>() {
<span style="display:block;width:100%;background-color:#3c3d38">    <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">nagMode</span> <span style="color:#f92672">==</span> <span style="color:#ae81ff">1</span>) {
</span>        <span style="color:#66d9ef">var</span> <span style="color:#a6e22e">babNag</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">sessionStorage</span>.<span style="color:#a6e22e">getItem</span>(<span style="color:#e6db74">&#39;babn&#39;</span>);
        <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">babNag</span> <span style="color:#f92672">&gt;</span> <span style="color:#ae81ff">0</span>) {
            <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">true</span> <span style="color:#75715e">// Stop the script.
</span><span style="color:#75715e"></span>        } <span style="color:#66d9ef">else</span> {
            <span style="color:#a6e22e">sessionStorage</span>.<span style="color:#a6e22e">setItem</span>(<span style="color:#e6db74">&#39;babn&#39;</span>, (Math.<span style="color:#a6e22e">random</span>() <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span>) <span style="color:#f92672">*</span> <span style="color:#ae81ff">1000</span>)
        }
    };
    ...
</code></pre></div>
    </details>

<aside class="aside-details"><code>nagMode</code> is set by the customizer, and is 0 by default. :(</aside>

<h3 id="blocking-blockadblock-version-1">Blocking BlockAdBlock, version 1</h3>
<p>Adblockers work by using what&rsquo;s called filters: lines of code that can block network requests and hide elements on the page.
By creating &ldquo;bait&rdquo; elements, BlockAdBlock triggers these filters on purpose.</p>
<p>With this simple defense, BlockAdBlock works against all major adblockers, like uBlock Origin, AdBlock Plus and Ghostery. To counter against this, we must write our own filter that&rsquo;s active only on BlockAdBlock-enhanced websites.</p>
<p><a href="https://help.eyeo.com/en/adblockplus/how-to-write-filters">Writing adblock filters</a> is a bit tricky.
The kind of filter we need is a <strong><a href="https://help.eyeo.com/en/adblockplus/how-to-write-filters#content-filters">content filter</a></strong>, which blocks elements on the page generated after download. Since the bait ad has an id of <code>banner_ad</code>, we create an <a href="https://help.eyeo.com/en/adblockplus/how-to-write-filters#elemhide_basic">element hiding exception</a>, marked <code>#@#</code>, for all elements <code>#</code> with id <code>banner_ad</code>, and put it in our adblocker&rsquo;s custom filter list.</p>
<p>Putting it all together, we get:</p>

<details open>
    
    <summary>Defeating BlockAdBlock, version 1.</summary>
    
        <div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-css" data-lang="css"><span style="color:#f92672">localhost</span><span style="color:#960050;background-color:#1e0010">#</span><span style="color:#f92672">@</span><span style="color:#960050;background-color:#1e0010">#</span> #banner_ad
</code></pre></div>
    </details>

<aside class="aside-details">I&rsquo;ve used localhost for demonstration, which you can replace with your URL.</aside>

<p>This counters BlockAdBlock successfully. The solution may seem basic, but it got the job done for a long time in the <a href="https://github.com/reek/anti-adblock-killer/blob/master/anti-adblock-killer-filters.txt#L150">Anti-AdBlock-Killer filter list</a>.</p>
<h2 id="version-2-november-2015---january-2016-a-few-improvements">Version 2 (November 2015 - January 2016): a few improvements</h2>
<div class="github-code">
    <i data-feather="github"></i>
    <a href="https://github.com/xy2iii/BlockAdBlock-reversed/blob/master/v2-reversed.js">Source code</a><a href="https://github.com/xy2iii/bab-history/commit/302e415b5d8d86d1749c6ea5d4b3a1d6fc995eb9#diff-f9901228d7dadbc695e79f98b44125e6">v1/v2 diff</a>
</div>
<h3 id="bait-ad-creation-less-bugs">Bait ad creation: less bugs</h3>
<p>There&rsquo;s a subtle bug in the first <a href="#bab-bait-ad-creation">bait ad creation</a> implementation above: the div that&rsquo;s created has no content, so it creates a 0 height by 0 width div.
Later, the code checks if the div was removed if the height and width of the bait div was empty. But since the div had 0 height, BlockAdBlock would always trigger.<sup id="fnref:4"><a href="#fn:4" class="footnote-ref" role="doc-noteref">4</a></sup></p>

<details open>
    
    <summary>Fixing the empty div bug.</summary>
    
        <div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-js" data-lang="js"><span style="color:#a6e22e">bab</span><span style="color:#f92672">:</span> <span style="color:#66d9ef">function</span>(...) {
    <span style="color:#a6e22e">bait</span> <span style="color:#f92672">=</span> document.<span style="color:#a6e22e">createElement</span>(<span style="color:#e6db74">&#39;DIV&#39;</span>);
    ...
    <span style="color:#a6e22e">bait</span>.<span style="color:#a6e22e">appendChild</span>(document.<span style="color:#a6e22e">createTextNode</span>(<span style="color:#e6db74">&#39;Â &#39;</span>));
</code></pre></div>
    </details>

<aside class="aside-details">A child div is created, with some content.</aside>

<h3 id="detection-via-fake-image-ads">Detection via fake image ads</h3>
<p>In this method, we create a fake image with a random name on <code>doubleclick.net</code>. Adblockers will block the image, thinking it to be an ad&rsquo;s image. However, this requires no change to block in our filter.</p>

<details open>
    
    <summary>Creating a fake image ad.</summary>
    
        <div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-js" data-lang="js"><span style="color:#a6e22e">bab</span><span style="color:#f92672">:</span> <span style="color:#66d9ef">function</span>(...) {
    <span style="color:#a6e22e">bait</span> <span style="color:#f92672">=</span> document.<span style="color:#a6e22e">createElement</span>(<span style="color:#e6db74">&#39;DIV&#39;</span>);
    <span style="color:#a6e22e">bait</span>.<span style="color:#a6e22e">innerHTML</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;&lt;img src=&#34;http://doubleclick.net/&#39;</span> <span style="color:#f92672">+</span> <span style="color:#a6e22e">randomStr</span>() <span style="color:#f92672">+</span> <span style="color:#e6db74">&#39;.jpg&#34;&gt;&#39;</span>;
    ...
</code></pre></div>
    </details>

<aside class="aside-details"><code>randomStr()</code> creates a random-length string.</aside>

<p>The other notable difference is the use of a <code>setInterval</code> timer instead of just checking once if the trigger is set.
It newly checks if the image ad still exists, and if its <code>src</code> attribute hasn&rsquo;t been modified, by checking the contents of the bait.</p>

<details open>
    
    <summary>A new <code>setInterval</code>, and checking for the image&rsquo;s existence.</summary>
    
        <div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-js" data-lang="js">    ...
    <span style="color:#a6e22e">checkCallback</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">setInterval</span>(<span style="color:#66d9ef">function</span>() {
        <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">bait</span>) {
            <span style="color:#a6e22e">check</span>((<span style="color:#a6e22e">bait</span>.<span style="color:#a6e22e">clientHeight</span> <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span>), <span style="color:#a6e22e">delay</span>);
            <span style="color:#a6e22e">check</span>((<span style="color:#a6e22e">bait</span>.<span style="color:#a6e22e">clientWidth</span> <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span>), <span style="color:#a6e22e">delay</span>);
            <span style="color:#a6e22e">check</span>((<span style="color:#a6e22e">bait</span>.<span style="color:#a6e22e">display</span> <span style="color:#f92672">==</span> <span style="color:#e6db74">&#39;hidden&#39;</span>), <span style="color:#a6e22e">delay</span>);
            <span style="color:#a6e22e">check</span>((<span style="color:#a6e22e">bait</span>.<span style="color:#a6e22e">visibility</span> <span style="color:#f92672">==</span> <span style="color:#e6db74">&#39;none&#39;</span>), <span style="color:#a6e22e">delay</span>);
            <span style="color:#a6e22e">check</span>((<span style="color:#a6e22e">bait</span>.<span style="color:#a6e22e">opacity</span> <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span>), <span style="color:#a6e22e">delay</span>);
            <span style="color:#66d9ef">try</span> {
<span style="display:block;width:100%;background-color:#3c3d38">                <span style="color:#a6e22e">check</span>((document.<span style="color:#a6e22e">getElementById</span>(<span style="color:#e6db74">&#39;banner_ad&#39;</span>).<span style="color:#a6e22e">innerHTML</span>.<span style="color:#a6e22e">indexOf</span>(<span style="color:#e6db74">&#39;click&#39;</span>) <span style="color:#f92672">==</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>), <span style="color:#a6e22e">delay</span>)
</span>            } <span style="color:#66d9ef">catch</span> (<span style="color:#a6e22e">e</span>) {}
        } <span style="color:#66d9ef">else</span> {
            <span style="color:#a6e22e">check</span>(<span style="color:#66d9ef">true</span>, <span style="color:#a6e22e">delay</span>)
        }
    }, <span style="color:#ae81ff">1000</span>
</code></pre></div>
    </details>

<aside class="aside-details">Why <code>indexof('click')</code>? The image will look like this: src=&ldquo;double<strong>click</strong>.net/abcdefg.jpg&rdquo;, so we check if that substring still exists.</aside>

<h2 id="version-3-november-2015---march-2016-generalized-baiting">Version 3 (November 2015 - March 2016): generalized baiting</h2>
<div class="github-code">
    <i data-feather="github"></i>
    <a href="https://github.com/xy2iii/BlockAdBlock-reversed/blob/master/v3-reversed.js">Source code</a><a href="https://github.com/xy2iii/bab-history/commit/0cf84eb57a702a78e29d8cf69022a94ad521284b#diff-f9901228d7dadbc695e79f98b44125e6">v2/v3 diff</a>
</div>
<h3 id="bait-ad-creation-randomized-ids">Bait ad creation: randomized IDs</h3>
<p>The only change in this version, though a significant one, is the appearance of randomized IDs for the bait ad.
A new ID is taken from a list of ad IDs at page load, and is used for the bait ad, now placed in the middle of the page.</p>

<details >
    
    <summary>The list of random bait IDs.</summary>
    
        <div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-js" data-lang="js"><span style="color:#66d9ef">var</span> <span style="color:#a6e22e">baitIDs</span> <span style="color:#f92672">=</span> [
  <span style="color:#e6db74">&#34;ad-left&#34;</span>,
  <span style="color:#e6db74">&#34;adBannerWrap&#34;</span>,
  <span style="color:#e6db74">&#34;ad-frame&#34;</span>,
  <span style="color:#e6db74">&#34;ad-header&#34;</span>,
  <span style="color:#e6db74">&#34;ad-img&#34;</span>,
  <span style="color:#e6db74">&#34;ad-inner&#34;</span>,
  <span style="color:#e6db74">&#34;ad-label&#34;</span>,
  <span style="color:#e6db74">&#34;ad-lb&#34;</span>,
  <span style="color:#e6db74">&#34;ad-footer&#34;</span>,
  <span style="color:#e6db74">&#34;ad-container&#34;</span>,
  <span style="color:#e6db74">&#34;ad-container-1&#34;</span>,
  <span style="color:#e6db74">&#34;ad-container-2&#34;</span>,
  <span style="color:#e6db74">&#34;Ad300x145&#34;</span>,
  <span style="color:#e6db74">&#34;Ad300x250&#34;</span>,
  <span style="color:#e6db74">&#34;Ad728x90&#34;</span>,
  <span style="color:#e6db74">&#34;AdArea&#34;</span>,
  <span style="color:#e6db74">&#34;AdFrame1&#34;</span>,
  <span style="color:#e6db74">&#34;AdFrame2&#34;</span>,
  <span style="color:#e6db74">&#34;AdFrame3&#34;</span>,
  <span style="color:#e6db74">&#34;AdFrame4&#34;</span>,
  <span style="color:#e6db74">&#34;AdLayer1&#34;</span>,
  <span style="color:#e6db74">&#34;AdLayer2&#34;</span>,
  <span style="color:#e6db74">&#34;Ads_google_01&#34;</span>,
  <span style="color:#e6db74">&#34;Ads_google_02&#34;</span>,
  <span style="color:#e6db74">&#34;Ads_google_03&#34;</span>,
  <span style="color:#e6db74">&#34;Ads_google_04&#34;</span>,
  <span style="color:#e6db74">&#34;DivAd&#34;</span>,
  <span style="color:#e6db74">&#34;DivAd1&#34;</span>,
  <span style="color:#e6db74">&#34;DivAd2&#34;</span>,
  <span style="color:#e6db74">&#34;DivAd3&#34;</span>,
  <span style="color:#e6db74">&#34;DivAdA&#34;</span>,
  <span style="color:#e6db74">&#34;DivAdB&#34;</span>,
  <span style="color:#e6db74">&#34;DivAdC&#34;</span>,
  <span style="color:#e6db74">&#34;AdImage&#34;</span>,
  <span style="color:#e6db74">&#34;AdDiv&#34;</span>,
  <span style="color:#e6db74">&#34;AdBox160&#34;</span>,
  <span style="color:#e6db74">&#34;AdContainer&#34;</span>,
  <span style="color:#e6db74">&#34;glinkswrapper&#34;</span>,
  <span style="color:#e6db74">&#34;adTeaser&#34;</span>,
  <span style="color:#e6db74">&#34;banner_ad&#34;</span>,
  <span style="color:#e6db74">&#34;adBanner&#34;</span>,
  <span style="color:#e6db74">&#34;adbanner&#34;</span>,
  <span style="color:#e6db74">&#34;adAd&#34;</span>,
  <span style="color:#e6db74">&#34;bannerad&#34;</span>,
  <span style="color:#e6db74">&#34; ad_box&#34;</span>,
  <span style="color:#e6db74">&#34; ad_channel&#34;</span>,
  <span style="color:#e6db74">&#34; adserver&#34;</span>,
  <span style="color:#e6db74">&#34; bannerid&#34;</span>,
  <span style="color:#e6db74">&#34;adslot&#34;</span>,
  <span style="color:#e6db74">&#34;popupad&#34;</span>,
  <span style="color:#e6db74">&#34;adsense&#34;</span>,
  <span style="color:#e6db74">&#34;google_ad&#34;</span>,
  <span style="color:#e6db74">&#34;outbrain-paid&#34;</span>,
  <span style="color:#e6db74">&#34;sponsored_link&#34;</span>
];
</code></pre></div>
    </details>

<aside class="aside-details">A long list that demonstrates significant domain knowledge.</aside>


<details open>
    
    <summary>Random ID generation.</summary>
    
        <div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-js" data-lang="js">    <span style="color:#a6e22e">randomBaitID</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">baitIDs</span>[ Math.<span style="color:#a6e22e">floor</span>(Math.<span style="color:#a6e22e">random</span>() <span style="color:#f92672">*</span> <span style="color:#a6e22e">baitIDs</span>.<span style="color:#a6e22e">length</span>) ],
    ...
    <span style="color:#66d9ef">var</span> <span style="color:#a6e22e">passed_eid</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">randomBaitID</span>;
    <span style="color:#a6e22e">bait</span> <span style="color:#f92672">=</span> document.<span style="color:#a6e22e">createElement</span>(<span style="color:#e6db74">&#39;DIV&#39;</span>);    
    <span style="color:#a6e22e">bait</span>.<span style="color:#a6e22e">id</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">passed_eid</span>;
</code></pre></div>
    </details>

<aside class="aside-details">As this runs on every load, the bait&rsquo;s ID will be different each time.</aside>

<h3 id="blocking-blockadblock-version-3-to-latest">Blocking BlockAdBlock, version 3 to latest</h3>
<p>BlockAdBlock uses the blind spot of adblockers: if the filter allows all the above IDs, then it also allows genuine ads to pass through.
If you don&rsquo;t allow blocking the above IDs, then other filters which may use these IDs in their filters to target ads will not work anymore.</p>
<p>In a way, BlockAdBlock is <strong>forcing the adblocker to make itself useless</strong>.</p>
<p>In adblockers, we can run arbitrary JS before anything in the page runs. We could try to delete the BlockAdBlock object prematurely.
But to do that, we need the name of the object BlockAdBlock is attached to, <a href="#architecture">which is randomized each run,</a> which would require running the code.</p>
<p>uBlock Origin took another approach. The code is ran by <code>eval</code>, so what if we could define our own <code>eval</code> function that would block execution if we detect BlockAdBlock? In JS the <code>Proxy</code> object can accomplish this: any property, affectation and method can be replaced for any object.</p>
<p>This could be bypassed by not <code>eval</code>ing the initial BlockAdBlock payload and using it directly, so we also proxy the entrypoint: the <code>setTimeout</code> call. Since setTimeout is passed a string and not a function, we check the string.</p>

<details open>
    
    <summary>Defeating BlockAdBlock in <a href="https://github.com/gorhill/uBlock/blob/master/src/web_accessible_resources/nobab.js">uBlock Origin (src)</a>.</summary>
    
        <div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-js" data-lang="js"><span style="color:#66d9ef">const</span> <span style="color:#a6e22e">signatures</span> <span style="color:#f92672">=</span> [
    [ <span style="color:#e6db74">&#39;blockadblock&#39;</span> ],
    [ <span style="color:#e6db74">&#39;babasbm&#39;</span> ],
    [ <span style="color:#e6db74">/getItem\(&#39;babn&#39;\)/</span> ],
    [
        <span style="color:#e6db74">&#39;getElementById&#39;</span>,
        <span style="color:#e6db74">&#39;String.fromCharCode&#39;</span>,
        <span style="color:#e6db74">&#39;ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789&#39;</span>,
        <span style="color:#e6db74">&#39;charAt&#39;</span>,
        <span style="color:#e6db74">&#39;DOMContentLoaded&#39;</span>,
        <span style="color:#e6db74">&#39;AdBlock&#39;</span>,
        <span style="color:#e6db74">&#39;addEventListener&#39;</span>,
        <span style="color:#e6db74">&#39;doScroll&#39;</span>,
        <span style="color:#e6db74">&#39;fromCharCode&#39;</span>,
        <span style="color:#e6db74">&#39;&lt;&lt;2|r&gt;&gt;4&#39;</span>,
        <span style="color:#e6db74">&#39;sessionStorage&#39;</span>,
        <span style="color:#e6db74">&#39;clientWidth&#39;</span>,
        <span style="color:#e6db74">&#39;localStorage&#39;</span>,
        <span style="color:#e6db74">&#39;Math&#39;</span>,
        <span style="color:#e6db74">&#39;random&#39;</span>
    ],
];
<span style="color:#66d9ef">const</span> <span style="color:#a6e22e">check</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">function</span>(<span style="color:#a6e22e">s</span>) {
    <span style="color:#75715e">// check for signature 
</span><span style="color:#75715e"></span>};
</code></pre></div>
    </details>

<aside class="aside-details">A list of signatures: identifying patterns of the code. <code>check</code> checks an eval&rsquo;d string against these patterns.</aside>


<details open>
    
    <summary><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Proxy">Proxying</a> the <code>eval</code> and <code>setTimeout</code> functions.</summary>
    
        <div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-js" data-lang="js">window.eval <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> Proxy(window.eval, {
    <span style="color:#a6e22e">apply</span><span style="color:#f92672">:</span> <span style="color:#66d9ef">function</span>(<span style="color:#a6e22e">target</span>, <span style="color:#a6e22e">thisArg</span>, <span style="color:#a6e22e">args</span>) {
        <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">a</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">args</span>[<span style="color:#ae81ff">0</span>];
        <span style="color:#66d9ef">if</span> ( <span style="color:#66d9ef">typeof</span> <span style="color:#a6e22e">a</span> <span style="color:#f92672">!==</span> <span style="color:#e6db74">&#39;string&#39;</span> <span style="color:#f92672">||</span> <span style="color:#f92672">!</span><span style="color:#a6e22e">check</span>(<span style="color:#a6e22e">a</span>) ) {
            <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">target</span>.<span style="color:#a6e22e">apply</span>(<span style="color:#a6e22e">thisArg</span>, <span style="color:#a6e22e">args</span>);
        } 
        <span style="color:#75715e">// BAB detected: clean up.
</span><span style="color:#75715e"></span>        <span style="color:#66d9ef">if</span> ( document.<span style="color:#a6e22e">body</span> ) {
            document.<span style="color:#a6e22e">body</span>.<span style="color:#a6e22e">style</span>.<span style="color:#a6e22e">removeProperty</span>(<span style="color:#e6db74">&#39;visibility&#39;</span>);
        }
        <span style="color:#66d9ef">let</span> <span style="color:#a6e22e">el</span> <span style="color:#f92672">=</span> document.<span style="color:#a6e22e">getElementById</span>(<span style="color:#e6db74">&#39;babasbmsgx&#39;</span>);
        <span style="color:#66d9ef">if</span> ( <span style="color:#a6e22e">el</span> ) {
            <span style="color:#a6e22e">el</span>.<span style="color:#a6e22e">parentNode</span>.<span style="color:#a6e22e">removeChild</span>(<span style="color:#a6e22e">el</span>);
        }
    }
});
window.<span style="color:#a6e22e">setTimeout</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> Proxy(window.<span style="color:#a6e22e">setTimeout</span>, {
    <span style="color:#a6e22e">apply</span><span style="color:#f92672">:</span> <span style="color:#66d9ef">function</span>(<span style="color:#a6e22e">target</span>, <span style="color:#a6e22e">thisArg</span>, <span style="color:#a6e22e">args</span>) {
        <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">a</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">args</span>[<span style="color:#ae81ff">0</span>];
        <span style="color:#75715e">// Check that the passed string is not the BAB entrypoint.
</span><span style="color:#75715e"></span>        <span style="color:#66d9ef">if</span> (
            <span style="color:#66d9ef">typeof</span> <span style="color:#a6e22e">a</span> <span style="color:#f92672">!==</span> <span style="color:#e6db74">&#39;string&#39;</span> <span style="color:#f92672">||</span>
            <span style="color:#e6db74">/\.bab_elementid.$/</span>.<span style="color:#a6e22e">test</span>(<span style="color:#a6e22e">a</span>) <span style="color:#f92672">===</span> <span style="color:#66d9ef">false</span>
        ) {
            <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">target</span>.<span style="color:#a6e22e">apply</span>(<span style="color:#a6e22e">thisArg</span>, <span style="color:#a6e22e">args</span>);
        }
    }
});
</code></pre></div>
    </details>

<aside class="aside-details">If we are executing BlockAdBlock, then clean up.</aside>

<p>As we are now using a <a href="https://github.com/gorhill/uBlock/wiki/Static-filter-syntax#scriptlet-injection">scriptlet</a>, a custom piece of code ran by the adblocker, the filter changes slightly:</p>

<details open>
    
    <summary>Defeating BlockAdBlock, all versions: the filter.</summary>
    
        <div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-css" data-lang="css"><span style="color:#f92672">localhost</span><span style="color:#960050;background-color:#1e0010">##</span> <span style="color:#f92672">+</span><span style="color:#f92672">js</span><span style="color:#f92672">(</span><span style="color:#f92672">nobab</span><span style="color:#f92672">)</span>
</code></pre></div>
    </details>

<aside class="aside-details">This doesn&rsquo;t run by default on every site, for performance reasons, so specify it for each site with the script.</aside>

<h2 id="version-4-january-2016---april-2016-experimental-features">Version 4 (January 2016 - April 2016): experimental features</h2>
<div class="github-code">
    <i data-feather="github"></i>
    <a href="https://github.com/xy2iii/BlockAdBlock-reversed/blob/master/v4-reversed.js">Source code</a><a href="https://github.com/xy2iii/bab-history/commit/a497819b713fa94ef7fa202c8fc1e9578cffe784#diff-f9901228d7dadbc695e79f98b44125e6">v3/v4 diff</a>
</div>
<p>The above detection method was made in <a href="https://github.com/uBlockOrigin/uAssets/blob/91f936dbaeaa681fab4d9259a818458db2200e74/assets/ublock/resources.txt#L493">January 2016, according to uBlock Origin commit history</a>, and has not changed in concept since its inception.
BlockAdBlock never tried to work around this filter after its creation, by changing its code architecture. Instead, it continued development with more features. And when we go over to the BlockAdBlock page, we see an interesting tab: &ldquo;Need more anti-adblock power?&rdquo;.</p>
<picture>
    <source srcset="bab-advanced-detection.webp">
    <img class="" src="bab-advanced-detection.png" alt="Advanced detection">
</picture>
<p>Although those defenses are only available in a special tab, they are included in all scripts and executed by fittingly-named variables. In version 4, two are implemented:</p>
<ul>
<li><code>aDefOne</code>, the &ldquo;specific defense for AdSense sites&rdquo;.</li>
<li><code>aDefTwo</code>, the &ldquo;special element defense&rdquo;.</li>
</ul>
<h3 id="accidental-debug-comments">Accidental debug comments</h3>
<p>There&rsquo;s something I should mention before we go. When reversing this version, one function caught my eye:

<details open>
    
    <summary>A debug <code>console.log()</code> that&rsquo;s used in the code!</summary>
    
        <div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-js" data-lang="js"><span style="color:#66d9ef">function</span> <span style="color:#a6e22e">consolelog</span>(<span style="color:#a6e22e">e</span>) {
    <span style="color:#75715e">// &#34;Dev mode&#34; check: developpers of BAB must set window.consolelog to 1.
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">if</span> (window.<span style="color:#a6e22e">consolelog</span> <span style="color:#f92672">==</span> <span style="color:#ae81ff">1</span>) {
        <span style="color:#a6e22e">console</span>.<span style="color:#a6e22e">log</span>(<span style="color:#a6e22e">e</span>)
    }
};
</code></pre></div>
    </details>

<aside class="aside-details">This runs only if the global <code>consolelog</code> is set, like <code>window.consolelog = 1</code>.</aside>
</p>
<p>These debug comments are only available in this version of the code. If I hadn&rsquo;t been reversing each version, I never would have caught it. These comments provide valuable information on how the code works.</p>
<h3 id="advanced-defense-adsense">Advanced defense: AdSense</h3>
<p>All of these special defenses are put in <code>check</code> and not in <code>arm</code>, like the architecture would suggest.
This would suggest a change of developer that was perhaps unfamiliar with the codebase.</p>
<p>If AdSense is active on the page, we check that the ads which are supposed to be there still exist. If they&rsquo;re gone because of the adblocker, then BlockAdBlock activates.</p>

<details open>
    
    <summary>A clever defense: check if existing ads, created by AdSense, are gone.</summary>
    
        <div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-js" data-lang="js"><span style="color:#66d9ef">function</span> <span style="color:#a6e22e">check</span>() {
    ...
    <span style="color:#66d9ef">var</span> <span style="color:#a6e22e">q</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;ins.adsbygoogle&#39;</span>,
        <span style="color:#75715e">// Selects all Google ads in the document.
</span><span style="color:#75715e"></span>        <span style="color:#a6e22e">adsbygoogleQuery</span> <span style="color:#f92672">=</span> document.<span style="color:#a6e22e">querySelector</span>(<span style="color:#a6e22e">q</span>);

    <span style="color:#66d9ef">if</span> ((<span style="color:#a6e22e">adsbygoogleQuery</span>) <span style="color:#f92672">&amp;&amp;</span> (<span style="color:#a6e22e">adblockDetected</span> <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span>)) {
        <span style="color:#75715e">// Ads are not blocked, since the bait ad is still there,
</span><span style="color:#75715e"></span>        <span style="color:#75715e">// and adblockDetected hasn&#39;t been set
</span><span style="color:#75715e"></span>        <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">aDefOne</span> <span style="color:#f92672">==</span> <span style="color:#e6db74">&#39;yes&#39;</span>) {
            <span style="color:#a6e22e">consolelog</span>(<span style="color:#e6db74">&#39;case2: standard bait says ads are NOT blocked.&#39;</span>);
            <span style="color:#66d9ef">var</span> <span style="color:#a6e22e">adsbygoogle</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js&#39;</span>;
<span style="display:block;width:100%;background-color:#3c3d38">            <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">scriptExists</span>(<span style="color:#a6e22e">adsbygoogle</span>)) {
</span>                <span style="color:#a6e22e">consolelog</span>(<span style="color:#e6db74">&#39;case2: And Adsense pre-exists.&#39;</span>);
<span style="display:block;width:100%;background-color:#3c3d38">                <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">adsbygoogleQuery</span>.<span style="color:#a6e22e">innerHTML</span>.<span style="color:#a6e22e">replace</span>(<span style="color:#e6db74">/\s/g</span>, <span style="color:#e6db74">&#39;&#39;</span>).<span style="color:#a6e22e">length</span> <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span>) {
</span>                    <span style="color:#75715e">// The ad&#39;s content was cleared, so...
</span><span style="color:#75715e"></span>                    <span style="color:#a6e22e">consolelog</span>(<span style="color:#e6db74">&#39;case2: Ads are blocked.&#39;</span>);
                    window[<span style="color:#e6db74">&#39;&#39;</span> <span style="color:#f92672">+</span> <span style="color:#a6e22e">randomID</span> <span style="color:#f92672">+</span> <span style="color:#e6db74">&#39;&#39;</span>].<span style="color:#a6e22e">arm</span>()
                }
            }
        };
        <span style="color:#a6e22e">adblockDetected</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>
    }
    ...
</code></pre></div>
    </details>

<aside class="aside-details"><code>scriptExists</code> will check the entire page for a script with the given URL.</aside>

<p>The <code>scriptExists</code> implementation looks for a given script within the page. In this case, it will detect the Adsense script if it exists.<sup id="fnref:5"><a href="#fn:5" class="footnote-ref" role="doc-noteref">5</a></sup></p>

<details open>
    
    <summary>Compare the passed script URL against all scripts currently on the page.</summary>
    
        <div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-js" data-lang="js"><span style="color:#66d9ef">function</span> <span style="color:#a6e22e">scriptExists</span>(<span style="color:#a6e22e">href</span>) {
    <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">href</span>) <span style="color:#a6e22e">href</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">href</span>.<span style="color:#a6e22e">substr</span>(<span style="color:#a6e22e">href</span>.<span style="color:#a6e22e">length</span> <span style="color:#f92672">-</span> <span style="color:#ae81ff">15</span>);
    <span style="color:#66d9ef">var</span> <span style="color:#a6e22e">scripts</span> <span style="color:#f92672">=</span> document.<span style="color:#a6e22e">getElementsByTagName</span>(<span style="color:#e6db74">&#39;script&#39;</span>);
    <span style="color:#66d9ef">for</span> (<span style="color:#66d9ef">var</span> <span style="color:#a6e22e">i</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">scripts</span>.<span style="color:#a6e22e">length</span>; <span style="color:#a6e22e">i</span><span style="color:#f92672">--</span>;) {
        <span style="color:#66d9ef">var</span> <span style="color:#a6e22e">src</span> <span style="color:#f92672">=</span> String(<span style="color:#a6e22e">scripts</span>[<span style="color:#a6e22e">i</span>].<span style="color:#a6e22e">src</span>);
        <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">src</span>) <span style="color:#a6e22e">src</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">src</span>.<span style="color:#a6e22e">substr</span>(<span style="color:#a6e22e">src</span>.<span style="color:#a6e22e">length</span> <span style="color:#f92672">-</span> <span style="color:#ae81ff">15</span>);
<span style="display:block;width:100%;background-color:#3c3d38">        <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">src</span> <span style="color:#f92672">===</span> <span style="color:#a6e22e">href</span>) <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">true</span>
</span>    };
    <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">false</span>
};
</code></pre></div>
    </details>

<aside class="aside-details">Both the compared URL and all the script&rsquo;s URL&rsquo;s are trimmed to 15 characters, though I&rsquo;m not sure why.</aside>

<h3 id="advanced-defense-special-element-defense">Advanced defense: Special element defense</h3>
<p>This method, unlike the first one, has a disclaimer: <em>&ldquo;Please test after installation to ensure compatibility with your site.&quot;</em> To contextualize where we are in the code, let&rsquo;s look at <code>check</code>:</p>

<details open>
    
    <summary>This special defense only triggers if adblock wasn&rsquo;t detected and there is no AdSense script on the page.</summary>
    
        <div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-js" data-lang="js"><span style="color:#a6e22e">check</span><span style="color:#f92672">:</span> <span style="color:#66d9ef">function</span>(<span style="color:#a6e22e">checkPredicate</span>, <span style="color:#a6e22e">unused</span>) {
    <span style="color:#66d9ef">if</span> ((<span style="color:#a6e22e">checkPredicate</span>) <span style="color:#f92672">&amp;&amp;</span> (<span style="color:#a6e22e">adblockDetected</span> <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span>)) {
        <span style="color:#75715e">// Adblocker detected, arm
</span><span style="color:#75715e"></span>    } <span style="color:#66d9ef">else</span> {
        <span style="color:#66d9ef">var</span> <span style="color:#a6e22e">q</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;ins.adsbygoogle&#39;</span>,
            <span style="color:#a6e22e">adsbygoogleQuery</span> <span style="color:#f92672">=</span> document.<span style="color:#a6e22e">querySelector</span>(<span style="color:#a6e22e">q</span>);

        <span style="color:#66d9ef">if</span> ((<span style="color:#a6e22e">adsbygoogleQuery</span>) <span style="color:#f92672">&amp;&amp;</span> (<span style="color:#a6e22e">adblockDetected</span> <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span>)) {
            <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">aDefOne</span> <span style="color:#f92672">==</span> <span style="color:#e6db74">&#39;yes&#39;</span>) {
                <span style="color:#75715e">// Special defense one: AdSense defense (see above)
</span><span style="color:#75715e"></span>            };
        } <span style="color:#66d9ef">else</span> {
<span style="display:block;width:100%;background-color:#3c3d38">            <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">adblockDetected</span> <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span>) {
</span>                <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">aDefTwo</span> <span style="color:#f92672">==</span> <span style="color:#e6db74">&#39;yes&#39;</span>) {
                    <span style="color:#75715e">// Special defense two: Special element defense
</span><span style="color:#75715e"></span>                }
            }
        }
    }
</code></pre></div>
    </details>

<aside class="aside-details">This method assumes that owners will only be using AdSense to serve ads on their page: if the AdSense script doesn&rsquo;t exist, there must be something wrong.</aside>

<p>So why the disclaimer? This method tries to include the AdSense script. If it doens&rsquo;t load, it&rsquo;s likely the adblocker blocked the network request, so BlockAdBlock triggers.
But this may mess up some web sites, hence the warning.</p>

<details open>
    
    <summary>If we fail to load AdSense, trigger the overlay.</summary>
    
        <div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-js" data-lang="js"><span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">aDefTwo</span> <span style="color:#f92672">==</span> <span style="color:#e6db74">&#39;yes&#39;</span>) {
    <span style="color:#75715e">/* Add Google ad code to head.
</span><span style="color:#75715e">        If it errors, the adblocker must have blocked the connection. */</span>
    <span style="color:#66d9ef">var</span> <span style="color:#a6e22e">googleAdCode</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;//static.doubleclick.net/instream/ad_status.js&#39;</span>;
    <span style="color:#a6e22e">consolelog</span>(<span style="color:#e6db74">&#39;case3: standard bait says ads are NOT blocked. Maybe ???\
</span><span style="color:#e6db74">      No Adsense is found. Attempting to add Google ad code to head...&#39;</span>);
    <span style="color:#66d9ef">var</span> <span style="color:#a6e22e">script</span> <span style="color:#f92672">=</span> document.<span style="color:#a6e22e">createElement</span>(<span style="color:#e6db74">&#39;script&#39;</span>);
    <span style="color:#a6e22e">script</span>.<span style="color:#a6e22e">setAttribute</span>(<span style="color:#e6db74">&#39;type&#39;</span>, <span style="color:#e6db74">&#39;text/javascript&#39;</span>);
    <span style="color:#a6e22e">script</span>.<span style="color:#a6e22e">setAttribute</span>(<span style="color:#e6db74">&#39;src&#39;</span>, <span style="color:#a6e22e">googleAdCode</span>);
<span style="display:block;width:100%;background-color:#3c3d38">    <span style="color:#a6e22e">script</span>.<span style="color:#a6e22e">onerror</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">function</span>() {
</span><span style="display:block;width:100%;background-color:#3c3d38">        window[<span style="color:#e6db74">&#39;&#39;</span> <span style="color:#f92672">+</span> <span style="color:#a6e22e">randomID</span> <span style="color:#f92672">+</span> <span style="color:#e6db74">&#39;&#39;</span>].<span style="color:#a6e22e">arm</span>()
</span><span style="display:block;width:100%;background-color:#3c3d38">    };
</span>    <span style="color:#a6e22e">adblockDetected</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>;
    <span style="color:#66d9ef">if</span> (<span style="color:#f92672">!</span><span style="color:#a6e22e">scriptExists</span>(<span style="color:#a6e22e">googleAdCode</span>)) {
        document.<span style="color:#a6e22e">getElementsByTagName</span>(<span style="color:#e6db74">&#39;head&#39;</span>)[<span style="color:#ae81ff">0</span>].<span style="color:#a6e22e">appendChild</span>(<span style="color:#a6e22e">script</span>)
    };
    <span style="color:#a6e22e">adsbygoogleQuery</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
    window[<span style="color:#e6db74">&#39;&#39;</span> <span style="color:#f92672">+</span> <span style="color:#a6e22e">randomID</span> <span style="color:#f92672">+</span> <span style="color:#e6db74">&#39;&#39;</span>].<span style="color:#a6e22e">check</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">function</span>() {
        <span style="color:#66d9ef">return</span>
    }
}
</code></pre></div>
    </details>

<aside class="aside-details"><code>onerror</code> fires upon a failure on at network level, like an adblocker blocking the request.</aside>

<p>And indeed, most adblockers fall for it and block the request.
However, there&rsquo;s one adblocker that I haven&rsquo;t mentionned until this point. Let&rsquo;s talk about the <a href="https://brave.com/fr/">Brave browser</a>.</p>
<h3 id="brave-browsers-answer-to-blockadblock">Brave Browser&rsquo;s answer to BlockAdBlock</h3>
<p>Until now I&rsquo;ve examined uBlock Origin&rsquo;s response against BlockAdBlock. And it works, but it needs a specific filter to be added for each site that has BlockAdBlock on it.
Brave is impressive because it detects and circumvents BlockAdBlock  on all versions, without any action needed. To do so, it spoofs the request directly at the network level.<sup id="fnref:6"><a href="#fn:6" class="footnote-ref" role="doc-noteref">6</a></sup></p>
<p>Instead of blocking the <code>ad_status.js</code> request, it lets it through but loads a <strong>0-byte fake Google Ads instead</strong>. This clever trick fools BlockAdBlock, because <code>onerror</code> fires only if the network request fails.</p>
<picture>
    <source srcset="chromium-brave.webp">
    <img class="" src="chromium-brave.png" alt="Chromium with adblocker &amp; Brave vs BlockAdBlock: network requests">
</picture>
<h2 id="version-5-march-2016---november-2016">Version 5 (March 2016 - November 2016)</h2>
<div class="github-code">
    <i data-feather="github"></i>
    <a href="https://github.com/xy2iii/BlockAdBlock-reversed/blob/master/v5-reversed.js">Source code</a><a href="https://github.com/xy2iii/bab-history/commit/b20d45201125767d63f5718b44a47082847e49bf#diff-f9901228d7dadbc695e79f98b44125e6">v4/v5 diff</a>
</div>
<h3 id="advanced-defense-favicon-spam">Advanced defense: Favicon spam</h3>
<p>The only change of note in this version is that the second advanced defense was rewritten, but still holds the same basic principle: try network requests that will be blocked by the adblocker. This time, however, it tries to load favicons instead of AdSense.</p>
<p>Brave evades this detection in the same was as above. It loads the images correctly, but creates fake 1x1 images.</p>

<details open>
    
    <summary>Favicon spam. <code>baitImages</code> generates bait images, too.</summary>
    
        <div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-js" data-lang="js"><span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">aDefTwo</span> <span style="color:#f92672">==</span> <span style="color:#e6db74">&#39;yes&#39;</span>) {
    <span style="color:#66d9ef">if</span> (<span style="color:#f92672">!</span> window[<span style="color:#e6db74">&#39;&#39;</span> <span style="color:#f92672">+</span> <span style="color:#a6e22e">randomID</span> <span style="color:#f92672">+</span> <span style="color:#e6db74">&#39;&#39;</span>].<span style="color:#a6e22e">ranAlready</span>) {<span style="color:#960050;background-color:#1e0010">/</span>
        <span style="color:#66d9ef">var</span> <span style="color:#a6e22e">favicons</span> <span style="color:#f92672">=</span> [
            <span style="color:#e6db74">&#34;//www.google.com/adsense/start/images/favicon.ico&#34;</span>,
            <span style="color:#e6db74">&#34;//www.gstatic.com/adx/doubleclick.ico&#34;</span>,
            <span style="color:#e6db74">&#34;//advertising.yahoo.com/favicon.ico&#34;</span>,
            <span style="color:#e6db74">&#34;//ads.twitter.com/favicon.ico&#34;</span>,
            <span style="color:#e6db74">&#34;//www.doubleclickbygoogle.com/favicon.ico&#34;</span>
            ],
            <span style="color:#a6e22e">len</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">favicons</span>.<span style="color:#a6e22e">length</span>,
            <span style="color:#a6e22e">img</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">favicons</span>[Math.<span style="color:#a6e22e">floor</span>(Math.<span style="color:#a6e22e">random</span>() <span style="color:#f92672">*</span> <span style="color:#a6e22e">len</span>)],
        ...
        <span style="color:#a6e22e">baitImages</span>(Math.<span style="color:#a6e22e">floor</span>(Math.<span style="color:#a6e22e">random</span>() <span style="color:#f92672">*</span> <span style="color:#ae81ff">2</span>) <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span>); <span style="color:#75715e">// creates bait images
</span><span style="color:#75715e"></span>        <span style="color:#66d9ef">var</span> <span style="color:#a6e22e">m</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> <span style="color:#a6e22e">Image</span>();
<span style="display:block;width:100%;background-color:#3c3d38">        <span style="color:#a6e22e">m</span>.<span style="color:#a6e22e">onerror</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">function</span>() {
</span>            <span style="color:#a6e22e">baitImages</span>(Math.<span style="color:#a6e22e">floor</span>(Math.<span style="color:#a6e22e">random</span>() <span style="color:#f92672">*</span> <span style="color:#ae81ff">2</span>) <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span>);
            <span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">src</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">imgCopy</span>;
            <span style="color:#a6e22e">baitImages</span>(Math.<span style="color:#a6e22e">floor</span>(Math.<span style="color:#a6e22e">random</span>() <span style="color:#f92672">*</span> <span style="color:#ae81ff">2</span>) <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span>)
        };
<span style="display:block;width:100%;background-color:#3c3d38">        <span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">onerror</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">function</span>() {
</span>            <span style="color:#a6e22e">adblockDetected</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>;
            <span style="color:#a6e22e">baitImages</span>(Math.<span style="color:#a6e22e">floor</span>(Math.<span style="color:#a6e22e">random</span>() <span style="color:#f92672">*</span> <span style="color:#ae81ff">3</span>) <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span>);
            window[<span style="color:#e6db74">&#39;&#39;</span> <span style="color:#f92672">+</span> <span style="color:#a6e22e">randomID</span> <span style="color:#f92672">+</span> <span style="color:#e6db74">&#39;&#39;</span>].<span style="color:#a6e22e">arm</span>()
        };
        <span style="color:#a6e22e">m</span>.<span style="color:#a6e22e">src</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">img</span>;
        <span style="color:#a6e22e">baitImages</span>(Math.<span style="color:#a6e22e">floor</span>(Math.<span style="color:#a6e22e">random</span>() <span style="color:#f92672">*</span> <span style="color:#ae81ff">3</span>) <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span>);
        window[<span style="color:#e6db74">&#39;&#39;</span> <span style="color:#f92672">+</span> <span style="color:#a6e22e">randomID</span> <span style="color:#f92672">+</span> <span style="color:#e6db74">&#39;&#39;</span>].<span style="color:#a6e22e">ranAlready</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">true</span>
    };
}
</code></pre></div>
    </details>

<aside class="aside-details"><code>baitImages</code> may be called so frequently, with a different, random amount of images, to throw off adblockers who want to block statically.</aside>

<h2 id="version-6-april-2016---november-2016-blocking-brave">Version 6 (April 2016 - November 2016): blocking Brave</h2>
<div class="github-code">
    <i data-feather="github"></i>
    <a href="https://github.com/xy2iii/BlockAdBlock-reversed/blob/master/v6-reversed.js">Source code</a><a href="https://github.com/xy2iii/bab-history/commit/6ab4ad4272cfcd131013702e144476abf2d5101e#diff-f9901228d7dadbc695e79f98b44125e6">v5/v6 diff</a>
</div>
<p>So far BlockAdBlock&rsquo;s techniques, although simplistic at first, have grown in terms of complexity and detection rate.
But there&rsquo;s still one enemy left unconquered: the Brave browser.</p>
<h3 id="advanced-defense-fake-favicon-detection">Advanced defense: Fake favicon detection</h3>
<p>Why did BlockAdBlock switch from trying to load a script to an image (a favicon)?
The answer is this code, which is put inside the &ldquo;favicon spam&rdquo; defense and activates if the Brave defense is active.</p>

<details open>
    
    <summary>Detecting Brave Browser: check the response for a fake image.</summary>
    
        <div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-js" data-lang="js"><span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">aDefTwo</span> <span style="color:#f92672">==</span> <span style="color:#e6db74">&#39;yes&#39;</span>) {
    <span style="color:#a6e22e">baitImages</span>(Math.<span style="color:#a6e22e">floor</span>(Math.<span style="color:#a6e22e">random</span>() <span style="color:#f92672">*</span> <span style="color:#ae81ff">3</span>) <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span>);
    <span style="color:#75715e">// earlier favicon code...
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">var</span> <span style="color:#a6e22e">m</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> <span style="color:#a6e22e">Image</span>();
    <span style="color:#66d9ef">if</span> ((<span style="color:#a6e22e">aDefThree</span> <span style="color:#f92672">%</span> <span style="color:#ae81ff">3</span>) <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span>) {
        <span style="color:#a6e22e">m</span>.<span style="color:#a6e22e">onload</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">function</span>() {
<span style="display:block;width:100%;background-color:#3c3d38">            <span style="color:#66d9ef">if</span> ((<span style="color:#a6e22e">m</span>.<span style="color:#a6e22e">width</span> <span style="color:#f92672">&lt;</span> <span style="color:#ae81ff">8</span>) <span style="color:#f92672">&amp;&amp;</span> (<span style="color:#a6e22e">m</span>.<span style="color:#a6e22e">width</span> <span style="color:#f92672">&gt;</span> <span style="color:#ae81ff">0</span>)) {
</span>                window[<span style="color:#e6db74">&#39;&#39;</span> <span style="color:#f92672">+</span> <span style="color:#a6e22e">randomID</span> <span style="color:#f92672">+</span> <span style="color:#e6db74">&#39;&#39;</span>].<span style="color:#a6e22e">arm</span>()
            }
        }
    };
}
</code></pre></div>
    </details>

<aside class="aside-details">Check the favicon&rsquo;s size. If it&rsquo;s less than 8x8, it was probably swapped out by Brave.</aside>

<p>With this method, Brave is defeated, and other adblockers will be detected if they run the code (most, like uBlock Origin, outright block it in the first place.)</p>
<p>After this update, around the end of November 2016, BlockAdBlock disappeared from the web. Although their &ldquo;advanced defense&rdquo; techniques work, they were never enabled for the majority of users. This was their last update, and their last post on both Twitter and their site was sometimes in late 2017.</p>
<p>However, the legacy BlockAdBlock left is significant. And even though it can be trivially blocked nowadays, I still see BlockAdBlock used in today&rsquo;s sites.</p>
<h2 id="conclusion">Conclusion</h2>
<p>In the end, who will win the arms race between ad-blockers and ad-blockers-blockers? Only time can tell, but I think ad-blockers still have the advantage. As the arms race evolves, ad-blockers will have to use more and more contrived techniques and completely custom code, as watching BlockAdBlock&rsquo;s evolution over time hopefully shows.</p>
<p>On the other hand, blockers have the advantage of stable systems and powerful filtering tools via filter lists, and have access to JavaScript, too: with these systems, it only takes one person to figure out how to defeat the adblocker and update the filter list with new sites.</p>
<p>By analysing BlockAdBlock&rsquo;s evolution over time, as well as various ad blocker&rsquo;s responses, we managed to draw a picture of the small war between BlockAdBlock and ad blockers, and in the process learnt how ad-blockers-blockers block the ad-blockers.</p>
<p><a href="https://github.com/xy2iii/BlockAdBlock-reversed">You can find my reverse-engineering on GitHub</a>. Thank you for reading.</p>
<!-- raw HTML omitted -->
<!-- raw HTML omitted -->
<section class="footnotes" role="doc-endnotes">
<hr>
<ol>
<li id="fn:1" role="doc-endnote">
<p>If you want an intuition of how it works, try pasting the below example into a JS console and then look at the code. If you&rsquo;re interested in its inner workings, <a href="https://github.com/evanw/packer/blob/master/packer.js">here&rsquo;s the source code</a>.&#160;<a href="#fnref:1" class="footnote-backref" role="doc-backlink">&#x21a9;&#xfe0e;</a></p>
</li>
<li id="fn:2" role="doc-endnote">
<p>Don&rsquo;t believe me? Try changing <code>eval</code> to <code>console.log</code> in the first line of the above example and you might find something hidden&hellip;&#160;<a href="#fnref:2" class="footnote-backref" role="doc-backlink">&#x21a9;&#xfe0e;</a></p>
</li>
<li id="fn:3" role="doc-endnote">
<p>The timestamp says <code>201510</code>, so shouldn&rsquo;t it be October? The reason for this is that we don&rsquo;t know when the script changed. All we know is:</p>
<ul>
<li>On 2015-10, there was one version saved: <code>20151007203811.js</code>.</li>
<li>On 2015-11, there was a new version: <code>20151113115955.js</code>.</li>
</ul>
<p>As far as we know, the script could have been changed the day before the second timestamp. As such, I err on the cautious side when timing the versions.&#160;<a href="#fnref:3" class="footnote-backref" role="doc-backlink">&#x21a9;&#xfe0e;</a></p>
</li>
<li id="fn:4" role="doc-endnote">
<p>The tests for v1, above, were made while fixing this bug in the v1 script.&#160;<a href="#fnref:4" class="footnote-backref" role="doc-backlink">&#x21a9;&#xfe0e;</a></p>
</li>
<li id="fn:5" role="doc-endnote">
<p>Thanks to <a href="https://www.reddit.com/r/javascript/comments/fs9030/how_an_anti_adblocker_works_reverseengineering/fm18g9m?utm_source=share&amp;utm_medium=web2x">McStroyer on Reddit</a> for pointing this out.&#160;<a href="#fnref:5" class="footnote-backref" role="doc-backlink">&#x21a9;&#xfe0e;</a></p>
</li>
<li id="fn:6" role="doc-endnote">
<p>Brave&rsquo;s adblock component is open source, so we can peek at the source to get an intuition on how it works.</p>
<ul>
<li>A method <a href="https://github.com/brave/brave-core/blob/master/components/brave_shields/browser/ad_block_base_service.cc#L37">ResourceTypeToString</a> evalutates what kind of resource is intercepted.</li>
<li>Brave&rsquo;s ad blocker, in <a href="https://github.com/brave/brave-core/blob/master/components/brave_shields/browser/ad_block_base_service.cc#L120">ShouldStartRequest</a>, checks if an intercepted resource <a href="https://github.com/brave/brave-core/blob/master/components/brave_shields/browser/ad_block_base_service.cc#L137">matches an adblock rule</a>.</li>
<li>If it does, it then returns a <a href="https://github.com/brave/brave-core/blob/88d1bbf718795ae4ddbfe8eb9104c1a06abd52e4/browser/net/brave_ad_block_tp_network_delegate_helper.cc#L88">fake resource</a> based on the earlier resource type, and makes the request &ldquo;successful&rdquo;.</li>
</ul>
<p>Thanks to <a href="https://fmarier.org/">Francois Marier</a> for pointing out that Brave is open-source.&#160;<a href="#fnref:6" class="footnote-backref" role="doc-backlink">&#x21a9;&#xfe0e;</a></p>
</li>
</ol>
</section>

    </div>
</div>

    <script src="/js/copy-code.js"></script>

<script src="/js/feather.min.js"></script>
<script>
    feather.replace()
</script>

    </main>
  </div>
  
</body>
</html>
